<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Take Test - IELTS Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen">
    <script>
        const currentStudent = JSON.parse(localStorage.getItem('currentStudent') || '{}');
        if (!currentStudent.id) {
            window.location.href = 'login.html';
        }
    </script>

    <div class="container mx-auto px-4 py-8">
        <!-- Header -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">IELTS Test Center</h1>
                    <p class="text-gray-600">Welcome, <span id="studentName">${currentStudent.name}</span></p>
                </div>
                <div class="text-right">
                    <div id="testTimer" class="text-2xl font-bold text-red-600">60:00</div>
                    <div class="text-sm text-gray-600">Time Remaining</div>
                </div>
            </div>
        </div>

        <!-- Available Tests -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-6">
            <h2 class="text-2xl font-bold mb-4">Available Tests</h2>
            <div id="availableTests" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Tests will be loaded here -->
            </div>
        </div>

        <!-- Test Interface (Hidden by default) -->
        <div id="testInterface" class="hidden">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 id="testTitle" class="text-2xl font-bold">Test Title</h2>
                    <button onclick="exitTest()" class="bg-red-600 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-times mr-2"></i>Exit Test
                    </button>
                </div>
                
                <div id="testQuestions" class="space-y-6">
                    <!-- Questions will be loaded here -->
                </div>
                
                <div class="mt-8 flex justify-between">
                    <button onclick="previousQuestion()" class="bg-gray-600 text-white px-6 py-3 rounded-lg">
                        <i class="fas fa-arrow-left mr-2"></i>Previous
                    </button>
                    <button onclick="nextQuestion()" class="bg-blue-600 text-white px-6 py-3 rounded-lg">
                        Next <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
                
                <div class="mt-6 text-center">
                    <button onclick="submitTest()" class="bg-green-600 text-white px-8 py-3 rounded-lg font-semibold">
                        <i class="fas fa-paper-plane mr-2"></i>Submit Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTest = null;
        let currentQuestionIndex = 0;
        let studentAnswers = {};
        let timerInterval = null;

        function loadAvailableTests() {
            const tests = JSON.parse(localStorage.getItem('tests') || '[]');
            const availableTests = tests.filter(test => test.active);
            const container = document.getElementById('availableTests');
            
            if (availableTests.length === 0) {
                container.innerHTML = `
                    <div class="col-span-3 text-center py-8">
                        <i class="fas fa-clipboard-list text-4xl text-gray-300 mb-4"></i>
                        <p class="text-gray-500">No tests available at the moment</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = availableTests.map(test => `
                <div class="border border-gray-200 rounded-2xl p-6 hover:shadow-md transition-shadow">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="font-bold text-lg text-gray-800">${test.title}</h3>
                        <span class="px-2 py-1 rounded-full text-xs capitalize ${
                            test.type === 'listening' ? 'bg-blue-100 text-blue-800' :
                            test.type === 'reading' ? 'bg-green-100 text-green-800' :
                            test.type === 'writing' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-purple-100 text-purple-800'
                        }">
                            ${test.type}
                        </span>
                    </div>
                    <p class="text-gray-600 text-sm mb-4">${test.description || 'No description available'}</p>
                    <div class="flex justify-between items-center text-sm text-gray-500 mb-4">
                        <span><i class="fas fa-star mr-1"></i>${test.marks} marks</span>
                        <span><i class="fas fa-clock mr-1"></i>${test.timeLimit || 60} min</span>
                    </div>
                    <button onclick="startTest(${test.id})" class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">
                        Start Test
                    </button>
                </div>
            `).join('');
        }

        function startTest(testId) {
            const tests = JSON.parse(localStorage.getItem('tests') || '[]');
            currentTest = tests.find(test => test.id === testId);
            
            if (!currentTest) return;
            
            // Hide available tests, show test interface
            document.getElementById('availableTests').classList.add('hidden');
            document.getElementById('testInterface').classList.remove('hidden');
            
            // Update test title
            document.getElementById('testTitle').textContent = currentTest.title;
            
            // Start timer
            startTimer(currentTest.timeLimit || 60);
            
            // Load first question
            loadQuestion(0);
        }

        function startTimer(minutes) {
            let timeLeft = minutes * 60;
            const timerElement = document.getElementById('testTimer');
            
            timerInterval = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    submitTest();
                    return;
                }
                
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                timerElement.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                timeLeft--;
            }, 1000);
        }

        function loadQuestion(index) {
            // For demo purposes, creating sample questions
            // In real implementation, you'd load from currentTest.questions
            const sampleQuestions = [
                {
                    id: 1,
                    text: "What is the main topic of the listening passage?",
                    type: "multiple-choice",
                    options: ["Climate change", "Technology", "Education", "Healthcare"]
                },
                {
                    id: 2,
                    text: "Describe the advantages of renewable energy in 150 words.",
                    type: "essay"
                }
            ];
            
            const question = sampleQuestions[index] || sampleQuestions[0];
            const container = document.getElementById('testQuestions');
            
            if (question.type === 'multiple-choice') {
                container.innerHTML = `
                    <div class="question">
                        <h3 class="text-lg font-semibold mb-4">Question ${index + 1}: ${question.text}</h3>
                        <div class="space-y-3">
                            ${question.options.map((option, i) => `
                                <label class="flex items-center space-x-3 p-3 border border-gray-200 rounded-lg hover:bg-gray-50 cursor-pointer">
                                    <input type="radio" name="question_${question.id}" value="${String.fromCharCode(65 + i)}" 
                                           ${studentAnswers[question.id] === String.fromCharCode(65 + i) ? 'checked' : ''}
                                           onchange="saveAnswer(${question.id}, '${String.fromCharCode(65 + i)}')">
                                    <span>${String.fromCharCode(65 + i)}. ${option}</span>
                                </label>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                container.innerHTML = `
                    <div class="question">
                        <h3 class="text-lg font-semibold mb-4">Question ${index + 1}: ${question.text}</h3>
                        <textarea class="w-full h-40 p-3 border border-gray-300 rounded-lg" 
                                  placeholder="Type your answer here..."
                                  oninput="saveAnswer(${question.id}, this.value)">${studentAnswers[question.id] || ''}</textarea>
                    </div>
                `;
            }
            
            currentQuestionIndex = index;
        }

        function saveAnswer(questionId, answer) {
            studentAnswers[questionId] = answer;
        }

        function nextQuestion() {
            loadQuestion(currentQuestionIndex + 1);
        }

        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                loadQuestion(currentQuestionIndex - 1);
            }
        }

        function exitTest() {
            if (confirm('Are you sure you want to exit? Your progress will be lost.')) {
                clearInterval(timerInterval);
                document.getElementById('testInterface').classList.add('hidden');
                document.getElementById('availableTests').classList.remove('hidden');
                currentTest = null;
                studentAnswers = {};
            }
        }

        async function submitTest() {
            clearInterval(timerInterval);
            
            const student = JSON.parse(localStorage.getItem('currentStudent'));
            const testResults = JSON.parse(localStorage.getItem('testResults') || '[]');
            
            // Calculate score (simplified)
            const score = Math.floor(Math.random() * 30) + 70; // Random score for demo
            
            const result = {
                id: Date.now(),
                studentId: student.id,
                studentName: student.name,
                testId: currentTest.id,
                testTitle: currentTest.title,
                score: score,
                totalMarks: currentTest.marks,
                answers: studentAnswers,
                submitted: new Date().toISOString(),
                timeTaken: '45:00' // You can calculate actual time
            };
            
            testResults.push(result);
            localStorage.setItem('testResults', JSON.stringify(testResults));
            
            // Send to Telegram
            await sendToTelegram(result);
            
            // Update student progress
            updateStudentProgress(student.id, score);
            
            alert(`Test submitted successfully! Your score: ${score}/${currentTest.marks}`);
            exitTest();
        }

        async function sendToTelegram(result) {
            const telegramConfig = JSON.parse(localStorage.getItem('telegramConfig') || '{}');
            
            if (!telegramConfig.token || !telegramConfig.chatId) {
                console.log('Telegram not configured');
                return;
            }
            
            const message = `
ðŸ“Š *New Test Submission*

ðŸ‘¤ *Student:* ${result.studentName}
ðŸ“ *Test:* ${result.testTitle}
ðŸŽ¯ *Score:* ${result.score}/${result.totalMarks} (${Math.round((result.score/result.totalMarks)*100)}%)
â° *Submitted:* ${new Date(result.submitted).toLocaleString()}

_Answers will be reviewed by teacher_
            `.trim();
            
            try {
                const response = await fetch(`https://api.telegram.org/bot${telegramConfig.token}/sendMessage`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        chat_id: telegramConfig.chatId,
                        text: message,
                        parse_mode: 'Markdown'
                    })
                });
                
                if (response.ok) {
                    console.log('Test results sent to Telegram');
                }
            } catch (error) {
                console.error('Error sending to Telegram:', error);
            }
        }

        function updateStudentProgress(studentId, score) {
            const students = JSON.parse(localStorage.getItem('students') || '[]');
            const student = students.find(s => s.id === studentId);
            
            if (student) {
                // Update progress (simplified calculation)
                student.progress = Math.min(100, (student.progress || 0) + 10);
                localStorage.setItem('students', JSON.stringify(students));
            }
        }

        // Load available tests when page loads
        document.addEventListener('DOMContentLoaded', loadAvailableTests);
    </script>
</body>
</html>
